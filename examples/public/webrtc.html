<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Screen Stream</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      body {
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #f0f0f0;
      }
      video {
        width: 80%;
        max-width: 1280px;
        border: 1px solid #ccc;
        background: black;
      }
      .status {
        margin: 10px;
        padding: 10px;
        background: white;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>WebRTC Screen Stream</h1>
    <div class="status" id="status">Connecting...</div>
    <video id="remoteVideo" autoplay playsinline controls></video>

    <script>
      const socket = io()
      const video = document.getElementById('remoteVideo')
      const status = document.getElementById('status')

      const pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
      })

      pc.ontrack = (event) => {
        console.log('Track received:', event)
        if (event.streams && event.streams[0]) {
          video.srcObject = event.streams[0]
          console.log('Using existing stream from event')
        } else {
          console.log('No stream in event, creating new MediaStream from track')
          const inboundStream = new MediaStream()
          inboundStream.addTrack(event.track)
          video.srcObject = inboundStream
        }
        status.textContent = 'Stream received!'
      }

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit('candidate', event.candidate)
        }
      }

      pc.onconnectionstatechange = () => {
        status.textContent = `Connection State: ${pc.connectionState}`
      }

      socket.on('connect', async () => {
        status.textContent = 'Socket connected. Waiting for stream...'
        // Client waits for offer from server
      })

      socket.on('offer', async (offer) => {
        console.log('Received offer')
        await pc.setRemoteDescription(offer)
        const answer = await pc.createAnswer()
        await pc.setLocalDescription(answer)
        socket.emit('answer', answer)
      })

      socket.on('answer', async (answer) => {
        await pc.setRemoteDescription(answer)
      })

      socket.on('candidate', async (candidate) => {
        await pc.addIceCandidate(candidate)
      })
    </script>
  </body>
</html>
